# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Essential Commands

### Infrastructure Management
- `make init` - Initialize Terraform (required first step)
- `make plan` - Show planned infrastructure changes
- `make apply` - Apply infrastructure changes
- `make destroy` - Destroy all infrastructure
- `make outputs` - Show Terraform outputs (IP addresses, etc.)

### Security & Validation
- `make check-security` - Run comprehensive security scans (gitleaks, trivy, checkov, semgrep)
- `make pre-commit-run` - Run pre-commit hooks manually
- `make validate` - Validate Terraform configuration
- `make fmt` - Format Terraform files

### CI/CD Integration
- **GitHub Actions**: Automated security scanning and validation on every push/PR
- **Security Gates**: Prevent deployment of vulnerable infrastructure
- **SARIF Integration**: Security results in GitHub Security tab
- **Dependabot**: Automated dependency security monitoring

### Server Access
- `make connect-docker` - SSH to Docker host directly
- `make connect-db` - SSH to database host via NAT jump host
- `make connect-nat` - SSH to NAT instance
- `make ip` - Show NAT instance public IP

### Ansible Operations
- `make inventory` - Generate Ansible inventory from Terraform outputs
- `make update-hosts` - Update OS packages on all hosts via Ansible
- `make setup-database` - Setup database instance with MariaDB and PostgreSQL
- `make setup-docker` - Setup Docker instance with Docker and Docker Compose
- `make setup-all` - Setup all instances (database and docker)
- `make ansible-requirements` - Install required Ansible collections

### Development Setup
- `./create_dev.py` - Generate development environment configuration files
- `./setup-dev.sh` - Set up development environment with pre-commit hooks
- `make setup-dev` - Alternative way to run development setup
- Requires `.env` file with AWS credentials and project settings

## Architecture Overview

### Infrastructure Design
This is a **multi-tier AWS infrastructure** with three main compute components:

1. **NAT Host** (public subnet) - Amazon Linux 2 ARM instance providing internet access for private resources
2. **Database Host** (private subnet) - Ubuntu instance for database services, accessible only via NAT jump host
3. **Docker Host** (public subnet) - Ubuntu instance for containerized applications

### Module Structure
- **modules/networking/** - VPC, subnets, routing, internet gateway
- **modules/compute/** - EC2 instances (nat_host, database_host, docker_host)
- **modules/security/** - Security groups and rules
- **modules/iam/** - IAM roles and policies

### Key Configuration Files
- **terraform.tfvars** - Environment-specific variables (generated from .env)
- **locals.tf** - Dynamic IP detection and common tags
- **variables.tf** - Variable definitions with validation
- **create-inventory.py** - Generates Ansible inventory from Terraform state

### Security Model
- Database host isolated in private subnet, access only via NAT jump host
- Security groups restrict access to specific ports and IP ranges
- Current IP automatically detected and whitelisted for NAT access
- Comprehensive security scanning: secrets (gitleaks), vulnerabilities (trivy), IaC misconfigurations (checkov), static analysis (semgrep)

### State Management
- Remote state stored in S3 bucket: `com-fortysheep-terraform-state`
- State locking via DynamoDB table: `terraform-locks`
- Backend configuration generated by `create_dev.py`

## Development Workflow

1. **Setup**: Create `.env` file with AWS credentials and run `./create_dev.py`
2. **Python Environment**: Set up virtual environment with `python3 -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt`
3. **Initialize**: Run `make init` to initialize Terraform
4. **Plan & Apply**: Use `make plan` then `make apply` to deploy
5. **Access**: Use `make connect-*` commands to access instances
6. **Ansible**: Run `make inventory` then `make update-hosts` for configuration management
7. **Security**: Always run `make check-security` before commits

## CI/CD Workflows

### GitHub Actions Workflows:
- **`.github/workflows/security-scan.yml`** - Comprehensive security scanning
- **`.github/workflows/terraform-validate.yml`** - Terraform validation and planning
- **`.github/workflows/ci-cd.yml`** - Combined CI/CD pipeline with security gates
- **`.github/dependabot.yml`** - Automated dependency updates
- **`.github/SECURITY.md`** - Security policy and vulnerability reporting

### Security Integration:
- **SARIF Reports**: Security results uploaded to GitHub Security tab
- **Pull Request Comments**: Automated security status in PR discussions
- **Security Gates**: Prevent merging of vulnerable code
- **Dependency Monitoring**: Automated updates for security patches

## Important Notes

- NAT instance must be ARM-based (t4g family) as specified in variables
- SSH key name must be configured in terraform.tfvars
- Database host requires NAT jump host for access (no direct internet connection)
- Ansible inventory is dynamically generated from Terraform state
- All instances use SSM roles for AWS Systems Manager access
- GitHub Actions workflows provide automated security validation
